"use strict";var _createClass=function(){function a(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(function(){jQuery(document).ready(function(u){return window.WC_Intuit_Payments_Tokenization_Handler=function(){function e(){var n=this;_classCallCheck(this,e),this.params=window.wc_intuit_payments_params,u(document.body).on("sv_wc_payment_form_valid_payment_data",function(e,t){return n.init(e,t)}),u(document.body).on("checkout_error",function(e){return u("input[name=wc-"+n.payment_form.id_dasherized+"-js-token]").val("")}),u(document.body).on("updated_checkout",function(){return n.handle_saved_payment_methods()})}return _createClass(e,[{key:"init",value:function(e,t){var n;if(this.payment_form=t.payment_form,("intuit_payments_credit_card"===(n=this.payment_form.id)||"intuit_payments_echeck"===n)&&!this.payment_form.saved_payment_method_selected&&t.passed_validation)return!!this.has_token()||("intuit_payments_credit_card"===this.payment_form.id?this.tokenize_method("credit_card"):this.tokenize_method("echeck"),!1)}},{key:"tokenize_method",value:function(e){var t,n=this;return this.payment_form.block_ui(),t=this.get_request_data(e),this.log_request(t),u.ajax(this.params.api_url,{method:"POST",dataType:"json",contentType:"application/json",crossDomain:!0,data:JSON.stringify(t),success:function(e){return n.handle_response(e)},error:function(e){return n.handle_response(e.responseJSON)}})}},{key:"get_request_data",value:function(e){var t,n,a,r,i,s,c,o;return t=u("input[id=wc-"+this.payment_form.id_dasherized+"-account-number]").val(),o=u("input[name=billing_first_name]").val()+" "+u("input[name=billing_last_name]").val(),a=u("#billing_country").val(),"credit_card"===e?(u("select[name=wc-"+this.payment_form.id_dasherized+"-test-case]").val()&&(o=u("select[name=wc-"+this.payment_form.id_dasherized+"-test-case]").val()),i=(c=u("input[name=wc-"+this.payment_form.id_dasherized+"-expiry]").payment("cardExpiryVal")).month.toString(),s=c.year.toString(),1===i.length&&(i="0"+i),r={card:{expYear:s,expMonth:i,name:o.substring(0,30),cvc:u("input[id=wc-"+this.payment_form.id_dasherized+"-csc]").val(),number:t}},a&&(r.card.address={region:u("#billing_state").val().substring(0,30),postalCode:u("input[name=billing_postcode]").val().substring(0,10),streetAddress:u("input[name=billing_address_1]").val().substring(0,30),country:a.substring(0,2),city:u("#billing_city").val().substring(0,30)})):("checking"===(n=u("#wc-"+this.payment_form.id_dasherized+"-account-type").val())?n="PERSONAL_CHECKING":"savings"===n&&(n="PERSONAL_SAVINGS"),r={bankAccount:{name:o.substring(0,30),routingNumber:u("input[id=wc-"+this.payment_form.id_dasherized+"-routing-number]").val(),accountNumber:t,accountType:n}},a&&(r.bankAccount.country=a.substring(0,2)),u("input[name=billing_phone]").length&&(r.bankAccount.phone=u("input[name=billing_phone]").val().replace(/\D/g,""))),r}},{key:"handle_response",value:function(e){return this.log_response(e),null!=e.value?(this.set_token(e.value),this.payment_form.form.submit()):(e.errors&&console.error(e.errors),this.payment_form.render_errors([this.params.generic_error]),this.payment_form.unblock_ui())}},{key:"set_token",value:function(e){var t,n;return u("input[name=wc-"+this.payment_form.id_dasherized+"-js-token]").val(e),n=u("input[id=wc-"+this.payment_form.id_dasherized+"-account-number]").val().slice(-4),u("input[name=wc-"+this.payment_form.id_dasherized+"-last-four]").val(n),t=u.payment.cardType(u("input[id=wc-"+this.payment_form.id_dasherized+"-account-number]").val()),u("input[name=wc-"+this.payment_form.id_dasherized+"-card-type]").val(t)}},{key:"has_token",value:function(){return u("input[name=wc-"+this.payment_form.id_dasherized+"-js-token]").val()}},{key:"handle_saved_payment_methods",value:function(){var t;return t="js-sv-wc-payment-gateway-credit-card-form-csc",u("input.js-wc-intuit-payments-credit-card-payment-token").change(function(){var e;return e=u("#wc-intuit-payments-credit-card-credit-card-form"),u("input.js-wc-intuit-payments-credit-card-payment-token:checked").val()?(e.hide(),u("#wc-intuit-payments-credit-card-csc").removeClass(t)):(u("#wc-intuit-payments-credit-card-csc").addClass(t),e.show())})}},{key:"log_request",value:function(e){var t,n;if(n={},e.card){for(t in e.card)n[t]=e.card[t];n.number&&(n.number=n.number.replace(/\d(?=\d{4})/g,"*")),n.cvc&&(n.cvc=n.cvc.replace(/[0-9]/g,"*"))}if(e.bankAccount){for(t in e.bankAccount)n[t]=e.bankAccount[t];n.accountNumber&&(n.accountNumber=n.accountNumber.replace(/\d(?=\d{4})/g,"*")),n.routingNumber&&(n.routingNumber=n.routingNumber.replace(/[0-9]/g,"*"))}return this.log_data(n,"request")}},{key:"log_response",value:function(e){return this.log_data(e,"response")}},{key:"log_data",value:function(e,t){var n;if(this.params.ajax_log)return n={action:"wc_"+this.payment_form.plugin_id+"_log_js_data",gateway_id:this.payment_form.id,security:this.params.ajax_log_nonce,type:t,data:e},u.ajax({url:this.params.ajax_url,data:n})}}]),e}(),window.wc_intuit_payments_tokenization_handler=new WC_Intuit_Payments_Tokenization_Handler})}).call(void 0);